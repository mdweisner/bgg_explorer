---
title: "BGG Explorer Github"
author: "Michael Weisner and Chana Messinger"
date: "November 2, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goals
+ K means cluster to recommendation?
+ Lasso penalized prediction of score
+ PCA Vector recommendation?

## To Do:
+ Talk to Ben about project (OK!)
+ Figure out what to do with data cleaning

## Libraries
```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(psych)
```
## BGG Data
```{r}
games <- read_csv(unzip("~/bgg_explorer/bgg_db_1806.csv.zip"))
games2 <- games # just backup in case we need to go back to original values
```

## Quick Cleaning
I used this to quickly cut out some outliers, but they need closer examination!
```{r}
games <- drop_na(games) # there's one NA column, annoyingly
games_clean <- games
outliers <- subset(games_clean, max_players > 32 | avg_time > 240 | min_time > 240 | max_time > 240 | age > 18 | year < 1950 | min_players == 0 | max_players == 0 | weight == 0 | mechanic == "none")
games_clean <- subset(games_clean, max_players <=32 & avg_time > 0 & min_time > 0 & max_time > 0 & avg_time <=480 & min_time <= 480 & max_time <= 480 & min_players > 0 & max_players > 0 & mechanic != "none")

#head(games_clean)
summary(games_clean)
```

Look at Outliers if necessary
```{r}
#View(outliers)
```

## Cleaning

### Drop Non-games
```{r}
bad_ids <- c("18291", "21804", "23953", "125048", "5985", "10904") # either nonspecific games like 'traditional card games' or non-games in the system
```


### Incorrect Values
```{r}
# Years
# 108018 (riichi mahjong) is credited as being adapted in 1924
```


### Mechanics
https://boardgamegeek.com/browse/boardgamemechanic
Create Dummy Variables for each mechanic

```{r}
mech_raw2 <- unlist(strsplit(games$mechanic, ", "))
mech_unique <- unique(mech_raw2)
mech_terms <- sort(mech_unique)

# Add columns for each mechanic type
games[, mech_terms] <- 0

# Update values of dummy mechanics if present in games$mechanic
for(j in 1:length(mech_terms)){
  for(i in 1:length(games$mechanic)){
    games[i, as.character(mech_terms[j])] <- as.numeric(grepl(mech_terms[j], games$mechanic[i]))
  }
  cat("now at", round(j * 1.96), "% ... ")
}


```


_OLD WAY / Double Check_
```{r eval=FALSE}
# mech_raw <- c("Acting","Action / Movement Programming", "Action Point Allowance System", 
#                "Area Control / Area Influence", "Area Enclosure", "Area Movement", "Area-Impulse",
#                "Auction/Bidding", "Betting/Wagering", "Campaign / Battle Card Driven", "Card Drafting",
#                "Chit-Pull System", "Commodity Speculation", "Co-operative Play", "Crayon Rail System",
#                "Deck / Pool Building", "Dice Rolling", "Grid Movement", "Hand Management", "Hex-and-Counter",
#                "Line Drawing", "Memory", "Modular Board", "Paper-and-Pencil", "Partnerships", "Pattern Building",
#                "Pattern Recognition", "Pick-up and Deliver", "Player Elimination", "Point to Point Movement",
#                "Press Your Luck", "Rock-Paper-Scissors", "Role Playing", "Roll / Spin and Move", "Route/Network Building",
#                "Secret Unit Deployment", "Set Collection", "Simulation", "Simultaneous Action Selection", "Singing",
#                "Stock Holding", "Storytelling", "Take That", "Tile Placement", "Time Track", "Trading", "Trick-taking",
#                "Variable Phase Order", "Variable Player Powers", "Voting", "Worker Placement")
# 
# 
# # Add columns for each mechanic type
# games[, mech_raw] <- 0
# 
# # Update values of dummy mechanics if present in games$mechanic
# for(j in 1:length(mech_raw)){
#   for(i in 1:length(games$mechanic)){
#     games[i, as.character(mech_raw[j])] <- as.numeric(grepl(mech_raw[j], games$mechanic[i]))
#   }
#   cat("now at", round(j * 1.96), "% ... ")
# }
# 
# # head(games)
```

### Rename Mechanics
```{r}
library(data.table)
### testing first
# colnames(games)
# testnames <- games[1:5, ]
# colnames(testnames) <- tolower(colnames(testnames))
# colnames(testnames) <- gsub("co-op", "coop", colnames(testnames)) # odd one out with dash
# colnames(testnames) <- gsub("\\/", " ", colnames(testnames))
# colnames(testnames) <- gsub("-", " ", colnames(testnames))
# colnames(testnames) <- gsub(" and ", " ", colnames(testnames))
# colnames(testnames) <- gsub("  ", " ", colnames(testnames))
# colnames(testnames) <- gsub("  ", " ", colnames(testnames))
# colnames(testnames) <- gsub(" ", "_", colnames(testnames))

colnames(games) <- tolower(colnames(games))
colnames(games) <- gsub("co-op", "coop", colnames(games)) # odd one out with dash
colnames(games) <- gsub("\\/", " ", colnames(games))
colnames(games) <- gsub("&", "", colnames(games))
colnames(games) <- gsub("-", " ", colnames(games))
colnames(games) <- gsub(" and ", " ", colnames(games))
colnames(games) <- gsub("  ", " ", colnames(games))
colnames(games) <- gsub("  ", " ", colnames(games))
colnames(games) <- gsub(" ", "_", colnames(games))
# colnames(games) <- gsub("none", "no_mech", colnames(games))

mech_old_names <- colnames(select(games, acting:worker_placement))
mech_new_names <- paste0('mech_', mech_old_names)
setnames(games, old = mech_old_names, new = mech_new_names)

head(select(games, mech_acting:mech_worker_placement))
```

### Check Nones
```{r}
sum(games$mech_none)
mech_miss <- games[games$mech_none == 1, ]
# games <- rename(games, no_mech = none )
```
### Total Mechanics
```{r}
games <- games %>%
  mutate(mech_total = rowSums(select(games, mech_acting:mech_worker_placement)))
summary(games$mech_total)
```

### Review Mech Stats
```{r}
describe(select(games, mech_acting:mech_worker_placement))
```

### Categories
Do the same thing with categories
https://boardgamegeek.com/browse/boardgamecategory
Maybe figure out way to just comma separate them into a new data frame and then pull out unique values?

_Old way (for doublechecking)_
```{r}
# cat_raw <- c("Abstract Strategy", "Action / Dexterity", "Adventure", "Age of Reason", "American Civil War", "American Indian Wars",
#              "American Revolutionary War", "American West", "Ancient", "Animals", "Arabian", "Aviation / Flight", "Bluffing", "Book",
#              "Card Game", "Children's Game", "City Building", "Civil War", "Civilization", "Collectible Components", "Comic Book / Strip",
#              "Deduction", "Dice", "Economic", "Educational", "Electronic", "Environmental", "Expansion for Base-game", "Exploration", 
#              "Fan Expansion", "Fantasy", "Farming", "Fighting", "Game System", "Horror", "Humor", "Industry / Manufacturing", 
#              "Korean War", "Mafia", "Math", "Mature / Adult","Maze", "Medical", "Medieval", "Memory", "Miniatures", "Modern Warfare", 
#              "Movies / TV / Radio theme", "Murder/Mystery", "Music", "Mythology", "Napoleonic", "Nautical", "Negotiation", "Novel-based", 
#              "Number", "Party Game", "Pike and Shot", "Pirates", "Political", "Post-Napoleonic", "Prehistoric", "Print & Play", "Puzzle", 
#              "Racing", "Real-time", "Religious", "Renaissance", "Science Fiction", "Space Exploration", "Spies/Secret Agents", "Sports", 
#              "Territory Building", "Trains", "Transportation", "Travel", "Trivia", "Video Game Theme", "Vietnam War", "Wargame", 
#              "Word Game", "World War I", "World War II", "Zombies")
```

_New Way_
```{r}
cat_raw2 <- unlist(strsplit(games$category, ", "))
cat_unique <- unique(cat_raw2)
cat_terms <- sort(cat_unique)

# Add columns for each mechanic type
games[, cat_terms] <- 0

# Update values of dummy mechanics if present in games$mechanic
for(j in 1:length(cat_terms)){
  for(i in 1:length(games$category)){
    games[i, as.character(cat_terms[j])] <- as.numeric(grepl(cat_terms[j], games$category[i]))
  }
  cat("now at", round(j * 1.19), "% ... ")
}

# head(games)
```
### Rename Categories
```{r}
colnames(games) <- tolower(colnames(games))
colnames(games) <- gsub("co-op", "coop", colnames(games)) # odd one out with dash
colnames(games) <- gsub("\\/", " ", colnames(games))
colnames(games) <- gsub("&", "", colnames(games))
colnames(games) <- gsub("-", " ", colnames(games))
colnames(games) <- gsub(" and ", " ", colnames(games))
colnames(games) <- gsub("  ", " ", colnames(games))
colnames(games) <- gsub("  ", " ", colnames(games))
colnames(games) <- gsub(" ", "_", colnames(games))
colnames(games) <- gsub("\\'", "", colnames(games))

#head(select(games, abstract_strategy:zombies))

cat_old_names <- colnames(select(games, abstract_strategy:zombies))
cat_new_names <- paste0('cat_', cat_old_names)
setnames(games, old = cat_old_names, new = cat_new_names)
head(games)
head(select(games, cat_abstract_strategy:cat_zombies))
```
### Total Categories
```{r}
games <- games %>%
  mutate(cat_total = rowSums(select(games, cat_abstract_strategy:cat_zombies)))
summary(games$cat_total)
```

### Check Nones
```{r}
sum(games$cat_none)
# games <- rename(games, no_cat = none)
cat_miss <- games[games$cat_none == 1, ]
```
### Check Both Missing
```{r}
missing_all <- cat_miss[cat_miss$mech_none == 1, ]
```

### Review Category Stats
```{r}
describe(select(games, cat_abstract_strategy:cat_zombies))
```


### Check Some Stats!
```{r}
filter(games, grepl("Harbour", names))
filter(games, grepl("Pandemic", ignore.case = TRUE, names))
filter(games, grepl("cthulhu", ignore.case = TRUE, names))
game_expansions <- games %>%
  filter(cat_expansion_for_base_game == 1)
game_expansions
```

### Times
```{r}
describe(games$avg_time)
```

### Num Players


## Quick LM
```{r error=TRUE}
lm_sub <- games %>%
  select(min_players:cat_total, -num_votes, -image_url, -mechanic, -category, -designer, -owned, -avg_rating, -mech_none, -cat_none)
lm1 <- lm(geek_rating ~ ., data = lm_sub)
summary(lm1)
```


## Plotting
```{r}
gg <- ggplot(data = games_clean, aes(x = geek_rating, y = owned, col = avg_time))
gg <- gg + geom_point()
gg <- gg + geom_smooth()
gg

```

